# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞

–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö SQLite –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–µ–ª, –æ—à–∏–±–æ–∫, –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –±–∏—Ä–∂.

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞

- `database.py` - –ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î
- `detected_alerts.db` - –§–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö SQLite (—Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

## üóÑÔ∏è –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `users`
–•—Ä–∞–Ω–∏—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | INTEGER | PRIMARY KEY |
| user | TEXT | –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| tg_token | TEXT | Telegram —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ |
| chat_id | TEXT | Telegram Chat ID |
| options_json | TEXT | JSON —Å—Ç—Ä–æ–∫–∞ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ (thresholds, exchanges) |
| created_at | TIMESTAMP | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è |
| updated_at | TIMESTAMP | –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è |

### –¢–∞–±–ª–∏—Ü–∞ `alerts`
–•—Ä–∞–Ω–∏—Ç –∏—Å—Ç–æ—Ä–∏—é –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–µ–ª (spikes).

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | INTEGER | PRIMARY KEY |
| ts | INTEGER | Timestamp –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö |
| exchange | TEXT | –ù–∞–∑–≤–∞–Ω–∏–µ –±–∏—Ä–∂–∏ (binance, gate, bitget, bybit) |
| market | TEXT | –¢–∏–ø —Ä—ã–Ω–∫–∞ (spot/linear) |
| symbol | TEXT | –¢–æ—Ä–≥–æ–≤–∞—è –ø–∞—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, BTCUSDT) |
| delta | REAL | –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö |
| wick_pct | REAL | –ü—Ä–æ—Ü–µ–Ω—Ç —Ç–µ–Ω–∏ —Å–≤–µ—á–∏ |
| volume_usdt | REAL | –û–±—ä—ë–º –≤ USDT |
| meta | TEXT | –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –º–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (JSON) |
| user_id | INTEGER | ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —Å—Ç—Ä–µ–ª–∞ (FOREIGN KEY) |
| created_at | TIMESTAMP | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ |

**–ò–Ω–¥–µ–∫—Å—ã:**
- `idx_alerts_ts` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
- `idx_alerts_exchange` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –±–∏—Ä–∂–µ
- `idx_alerts_market` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Ä—ã–Ω–∫—É
- `idx_alerts_symbol` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Å–∏–º–≤–æ–ª—É
- `idx_alerts_user_id` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- `idx_alerts_exchange_market` - —Å–æ—Å—Ç–∞–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –±–∏—Ä–∂–µ –∏ —Ä—ã–Ω–∫—É

### –¢–∞–±–ª–∏—Ü–∞ `errors`
–•—Ä–∞–Ω–∏—Ç –ª–æ–≥–∏ –æ—à–∏–±–æ–∫ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏.

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | INTEGER | PRIMARY KEY |
| timestamp | TIMESTAMP | –í—Ä–µ–º—è –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è –æ—à–∏–±–∫–∏ |
| exchange | TEXT | –ù–∞–∑–≤–∞–Ω–∏–µ –±–∏—Ä–∂–∏ |
| error_type | TEXT | –¢–∏–ø –æ—à–∏–±–∫–∏ (reconnect, websocket_error, critical, etc.) |
| error_message | TEXT | –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ |
| connection_id | TEXT | ID —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è WebSocket |
| market | TEXT | –¢–∏–ø —Ä—ã–Ω–∫–∞ |
| symbol | TEXT | –¢–æ—Ä–≥–æ–≤–∞—è –ø–∞—Ä–∞ |
| stack_trace | TEXT | –°—Ç–µ–∫ —Ç—Ä–µ–π—Å –æ—à–∏–±–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) |

**–ò–Ω–¥–µ–∫—Å—ã:**
- `idx_errors_timestamp` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
- `idx_errors_exchange` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –±–∏—Ä–∂–µ
- `idx_errors_error_type` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Ç–∏–ø—É –æ—à–∏–±–∫–∏

### –¢–∞–±–ª–∏—Ü–∞ `exchange_blacklists`
–ß—ë—Ä–Ω—ã–µ —Å–ø–∏—Å–∫–∏ —Å–∏–º–≤–æ–ª–æ–≤ –ø–æ –±–∏—Ä–∂–∞–º.

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | INTEGER | PRIMARY KEY |
| exchange | TEXT | –ù–∞–∑–≤–∞–Ω–∏–µ –±–∏—Ä–∂–∏ |
| market | TEXT | –¢–∏–ø —Ä—ã–Ω–∫–∞ (spot/linear) |
| symbol | TEXT | –¢–æ—Ä–≥–æ–≤–∞—è –ø–∞—Ä–∞ |
| created_at | TIMESTAMP | –î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è |

**–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å:** `(exchange, market, symbol)`

### –¢–∞–±–ª–∏—Ü–∞ `symbol_aliases`
–ê–ª–∏–∞—Å—ã —Å–∏–º–≤–æ–ª–æ–≤ (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è).

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | INTEGER | PRIMARY KEY |
| exchange | TEXT | –ù–∞–∑–≤–∞–Ω–∏–µ –±–∏—Ä–∂–∏ |
| market | TEXT | –¢–∏–ø —Ä—ã–Ω–∫–∞ (spot/linear) |
| original_symbol | TEXT | –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∏–º–≤–æ–ª–∞ |
| alias | TEXT | –ê–ª–∏–∞—Å (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ) |
| created_at | TIMESTAMP | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è |

**–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å:** `(exchange, market, original_symbol, alias)`

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î

–ë–î —Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∏–º–ø–æ—Ä—Ç–µ –º–æ–¥—É–ª—è:

```python
from BD.database import db

# –ë–î –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```python
user_id = db.create_user(
    user="test_user",
    tg_token="1234567890:ABC...",
    chat_id="123456789",
    options_json='{"thresholds": {"delta_pct": 1.0, "volume_usdt": 10000.0}}'
)
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–µ–ª—ã

```python
alert_id = db.add_alert(
    ts=1699123456000,  # timestamp –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
    exchange="binance",
    market="spot",
    symbol="BTCUSDT",
    delta=2.5,  # 2.5%
    wick_pct=45.0,  # 45%
    volume_usdt=150000.0,
    meta='{"price": 50000}',
    user_id=1
)
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç—Ä–µ–ª —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π

```python
alerts = db.get_alerts(
    exchange="binance",
    market="spot",
    user_id=1,
    ts_from=1699120000000,
    ts_to=1699130000000,
    delta_min=1.0,
    limit=100
)
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏

```python
db.add_error(
    error_type="websocket_error",
    error_message="Connection closed unexpectedly",
    exchange="binance",
    connection_id="ws_123",
    market="spot"
)
```

### –†–∞–±–æ—Ç–∞ —Å —á—ë—Ä–Ω—ã–º–∏ —Å–ø–∏—Å–∫–∞–º–∏

```python
# –î–æ–±–∞–≤–∏—Ç—å –≤ —á—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫
db.add_to_blacklist(exchange="binance", market="spot", symbol="SHIBUSDT")

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –≤ —á—ë—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ –ª–∏ —Å–∏–º–≤–æ–ª
if db.is_blacklisted("binance", "spot", "SHIBUSDT"):
    print("–°–∏–º–≤–æ–ª –≤ —á—ë—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ")

# –ü–æ–ª—É—á–∏—Ç—å –≤–µ—Å—å —á—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫
blacklist = db.get_blacklist(exchange="binance")
```

### –†–∞–±–æ—Ç–∞ —Å –∞–ª–∏–∞—Å–∞–º–∏

```python
# –î–æ–±–∞–≤–∏—Ç—å –∞–ª–∏–∞—Å
db.add_alias(
    exchange="binance",
    market="spot",
    original_symbol="BTCUSDT",
    alias="BTC"
)

# –ü–æ–ª—É—á–∏—Ç—å –∞–ª–∏–∞—Å
alias = db.get_alias("binance", "spot", "BTCUSDT")  # –í–µ—Ä–Ω—ë—Ç "BTC"
```

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- –í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
- –°–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É—é—Ç –∑–∞–ø—Ä–æ—Å—ã —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —É—Å–ª–æ–≤–∏—è–º–∏
- –î–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏

## üîß –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ

### –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –°–æ–∑–¥–∞—Ç—å –∫–æ–ø–∏—é –ë–î
cp BD/detected_alerts.db BD/detected_alerts.db.backup
```

### –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö

```python
# –ü—Ä–∏–º–µ—Ä: —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–µ–ª —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π
from datetime import datetime, timedelta
import time

thirty_days_ago = int((datetime.now() - timedelta(days=30)).timestamp() * 1000)
# –£–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ SQL (–Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ database.py, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–µ–ª**: –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞—é—Ç –æ–¥–Ω—É –∏ —Ç—É –∂–µ —Å—Ç—Ä–µ–ª—É (–æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ exchange, market, symbol, ts), –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –µ–≥–æ `user_id`. –≠—Ç–æ —É–ø—Ä–æ—â–∞–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.

2. **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏**: SQLite –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ–∞–π–ª–æ–≤—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏. –ü—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –¥—Ä—É–≥—É—é –ë–î.

3. **–†–∞–∑–º–µ—Ä –ë–î**: –ü—Ä–∏ –±–æ–ª—å—à–æ–º –æ–±—ä—ë–º–µ –¥–∞–Ω–Ω—ã—Ö (–º–∏–ª–ª–∏–æ–Ω—ã –∑–∞–ø–∏—Å–µ–π) —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:
   - –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –¥–∞—Ç–∞–º
   - –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ VACUUM –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –§–∞–π–ª –ë–î –Ω–µ –¥–æ–ª–∂–µ–Ω –ø–æ–ø–∞–¥–∞—Ç—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (–¥–æ–±–∞–≤–ª–µ–Ω –≤ `.gitignore`)
- Telegram —Ç–æ–∫–µ–Ω—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ - –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Ñ–∞–π–ª—É –ë–î –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

