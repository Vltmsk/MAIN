# План исправления проблем проекта

## Критические проблемы безопасности

### 1. Отсутствие rate limiting ✅ ВЫПОЛНЕНО
**Проблема**: API не защищён от злоупотреблений (brute-force атаки на логин, DDoS).

**Исправление**:
- ✅ Добавлен rate limiting middleware для FastAPI (библиотека `slowapi`)
- ✅ Ограничено количество запросов на аутентификацию (5 попыток в минуту с одного IP)
- ✅ Добавлен общий лимит для всех API endpoints

**Файлы**: `api_server.py`, `requirements.txt` ✅

### 2. SQLite конкурентность (check_same_thread=False) - ВЫБРАН ВАРИАНТ 2 ✅ ВЫПОЛНЕНО
**ВАЖНО: Проблема касается ВСЕХ операций записи в БД - и регистрации, И записи стрел!**

**Проблема простыми словами**: 
В файле `BD/database.py` на строке 44 есть параметр `check_same_thread=False`. При одновременных запросах (регистрация, запись стрел) могут возникать конфликты.

**Пример проблемы с записью стрел**:
```python
# Ситуация: найдена одна и та же свеча для двух пользователей одновременно

# Задача 1: Сохраняем стрелу для пользователя "Иван"
conn1 = sqlite3.connect(...)
conn1.execute("SELECT id FROM alerts WHERE ts=? AND exchange=? ...", (ts, exchange, ...))
# Не найдено - стрелы ещё нет
conn1.execute("INSERT INTO alerts (ts, exchange, ...) VALUES (?, ?, ...)", (ts, exchange, ...))
# Ещё не закоммитили

# В это же время Задача 2: Сохраняем ТУ ЖЕ стрелу для пользователя "Петр"
conn2 = sqlite3.connect(...)
conn2.execute("SELECT id FROM alerts WHERE ts=? AND exchange=? ...", (ts, exchange, ...))
# Тоже не найдено! (потому что первая транзакция ещё не закоммичена)
conn2.execute("INSERT INTO alerts (ts, exchange, ...) VALUES (?, ?, ...)", (ts, exchange, ...))
# ОШИБКА: UNIQUE constraint failed - обе попытки создать одну и ту же стрелу!
```

**Исправление (ВАРИАНТ 2 - ВЫБРАН)**: 
- ✅ Добавлен `aiosqlite` в `requirements.txt`
- ✅ Включен WAL режим для лучшей конкурентности
- ✅ Переделаны критичные методы на async/await:
  - `register_user` - регистрация пользователей
  - `authenticate_user` - аутентификация
  - `add_alert` - запись стрел (решает проблему конкурентности)
  - `get_whitelisted_username` - используется в регистрации
- ✅ Переделаны методы работы с пользователями на async/await:
  - `create_user` - создание/обновление пользователя
  - `get_user` - получение пользователя по имени
  - `get_user_by_id` - получение пользователя по ID
  - `get_all_users` - получение всех пользователей
  - `update_user_password` - обновление пароля
  - `update_user_settings` - обновление настроек
  - `update_user_timezone` - обновление временной зоны
  - `delete_user` - удаление пользователя
- ✅ Переделаны методы работы с белым списком на async/await:
  - `add_login_to_whitelist` - добавление логина в белый список
  - `remove_login_from_whitelist` - удаление логина из белого списка
  - `get_whitelist` - получение всего белого списка
- ✅ Переделаны методы работы со стрелами на async/await:
  - `get_alerts` - получение стрел с фильтрацией
  - `clear_alerts` - очистка стрел
  - `get_alerts_count` - подсчёт количества стрел
  - `delete_user_spikes` - удаление стрел пользователя
- ✅ Переделаны методы работы с ошибками на async/await:
  - `add_error` - добавление ошибки в БД
  - `get_errors` - получение ошибок
  - `delete_error` - удаление ошибки по ID
  - `delete_all_errors` - удаление всех ошибок
- ✅ Переделаны методы работы с чёрными списками на async/await:
  - `add_to_blacklist` - добавление символа в чёрный список
  - `remove_from_blacklist` - удаление символа из чёрного списка
  - `get_blacklist` - получение чёрного списка
  - `is_blacklisted` - проверка, находится ли символ в чёрном списке
- ✅ Переделаны методы работы с алиасами на async/await:
  - `add_alias` - добавление алиаса для символа
  - `get_alias` - получение алиаса для символа
  - `get_all_aliases` - получение всех алиасов
- ✅ Переделаны методы работы со статистикой на async/await:
  - `upsert_exchange_statistics` - сохранение/обновление статистики биржи
  - `get_exchange_statistics` - получение статистики бирж
- ✅ Обновлены все вызовы на await в `api_server.py`:
  - `db.create_user()` → `await db.create_user()`
  - `db.get_all_users()` → `await db.get_all_users()`
  - `db.get_user()` → `await db.get_user()`
  - `db.delete_user()` → `await db.delete_user()`
  - `db.get_whitelist()` → `await db.get_whitelist()`
  - `db.add_login_to_whitelist()` → `await db.add_login_to_whitelist()`
  - `db.remove_login_from_whitelist()` → `await db.remove_login_from_whitelist()`
  - `db.update_user_timezone()` → `await db.update_user_timezone()`
  - `db.get_alerts()` → `await db.get_alerts()`
  - `db.get_alerts_count()` → `await db.get_alerts_count()`
  - `db.delete_user_spikes()` → `await db.delete_user_spikes()`
  - `db.add_error()` → `await db.add_error()`
  - `db.get_errors()` → `await db.get_errors()`
  - `db.delete_error()` → `await db.delete_error()`
  - `db.delete_all_errors()` → `await db.delete_all_errors()`
  - `db.get_exchange_statistics()` → `await db.get_exchange_statistics()`
- ✅ Обновлены все вызовы на await в `main.py`:
  - `db.get_user_by_id()` → `await db.get_user_by_id()`
  - `db.upsert_exchange_statistics()` → `await db.upsert_exchange_statistics()`

**Файлы**: 
- `BD/database.py` ✅ (все 29 методов переделано на async)
- `requirements.txt` ✅
- `api_server.py` ✅ (все вызовы обновлены на await)
- `main.py` ✅ (все вызовы обновлены на await)

## Проблемы производительности

### 3. Потенциальные утечки памяти в _series_tracker ✅ ВЫПОЛНЕНО
**Проблема**: `_series_tracker` в `spike_detector.py` может накапливать данные для неактивных пользователей.

**Исправление**:
1. ✅ Добавлен TTL (Time To Live) - автоматически удалять записи старше 1 часа
2. ✅ Ограничен максимальный размер: не более 1000 записей на символ
3. ✅ Периодическая очистка: раз в час удалять данные для несуществующих пользователей
4. ✅ Очистка при удалении пользователя: удалять данные из трекера (метод `cleanup_user_data`)

**Файлы**: `core/spike_detector.py` ✅, `api_server.py` ✅

### 4. Глобальные переменные в main.py ✅ ВЫПОЛНЕНО
**Проблема**: Глобальные переменные `_all_tasks`, `_reconnect_logged`, `_exchange_start_times` могут вызывать проблемы при перезапуске.

**Исправление**:
- ✅ Инкапсулированы в класс `ExchangeManager`
- ✅ Добавлены методы для управления задачами, временем старта бирж и реконнектами
- ✅ Добавлен метод `clear_state()` для очистки состояния при перезапуске
- ✅ Все глобальные переменные заменены на использование экземпляра `exchange_manager`

**Файлы**: `main.py` ✅

## Архитектурные проблемы

### 5. Широкие блоки try-except - ВАЖНО ✅ ВЫПОЛНЕНО
**Проблема**: Слишком общие обработчики исключений скрывают реальные проблемы.

**Исправление**:
- ✅ В `api_server.py` заменены широкие блоки на конкретные типы исключений для критичных методов (регистрация, вход)
- ✅ Добавлено логирование ошибок БД (`sqlite3.IntegrityError`, `sqlite3.OperationalError`, `aiosqlite.*`)
- ✅ Все ошибки логируются с деталями (`exc_info=True`) и попадают в админ панель
- ✅ Критические исключения (KeyboardInterrupt, SystemExit) не перехватываются
- ✅ В `main.py` заменены широкие блоки на конкретные типы исключений:
  - Ошибки БД: `aiosqlite.IntegrityError`, `aiosqlite.OperationalError`
  - Ошибки парсинга JSON: `json.JSONDecodeError`, `ValueError`, `TypeError`
  - Ошибки сети Telegram: `asyncio.TimeoutError`, `aiohttp.ClientError`
  - Ошибки запуска бирж: `ImportError`, `AttributeError`
- ✅ В `BD/database.py` заменены все 33 широких блока try-except на конкретные типы исключений:
  - `aiosqlite.IntegrityError` - ошибки целостности
  - `aiosqlite.OperationalError` - операционные ошибки БД
  - `aiosqlite.Error` - базовый класс для всех ошибок aiosqlite (как fallback)

**Файлы**: `api_server.py` ✅, `main.py` ✅, `BD/database.py` ✅

### 6. Отсутствие централизованной обработки ошибок - ВАЖНО ✅ ВЫПОЛНЕНО
**Проблема**: Обработка ошибок разбросана по коду, нет единого места где все ошибки логируются в админ панель.

**Требование**: Все критические ошибки должны попадать в блок "логи" в админ панели.

**Исправление**:
- ✅ Создан централизованный exception handler для FastAPI:
  - `RequestValidationError` - ошибки валидации Pydantic
  - `StarletteHTTPException` - HTTP исключения
  - `Exception` - общий обработчик для всех необработанных исключений
- ✅ Все ошибки автоматически сохраняются в таблицу `errors` через `db.add_error()`
- ✅ Унифицирован формат ответов об ошибках

**Файлы**: `api_server.py` ✅

## Улучшения кода

### 7. Дублирование кода ✅ ВЫПОЛНЕНО
**Проблема**: Повторяющаяся логика в обработке пользователей и стрел.

**Исправление**:
- ✅ Создана утилита `core/db_error_handler.py` для централизованной обработки ошибок БД в API
- ✅ Создана утилита `BD/db_utils.py` с асинхронным контекстным менеджером для работы с БД
- ✅ Применена утилита обработки ошибок в критичных местах `api_server.py` (регистрация, вход)
- ✅ Устранено дублирование кода обработки ошибок БД (было ~30 строк повторяющегося кода на каждую операцию)

**Файлы**: 
- `core/db_error_handler.py` ✅ (новая утилита)
- `BD/db_utils.py` ✅ (новая утилита)
- `api_server.py` ✅ (применена утилита)

### 8. Логирование критических ошибок - ВАЖНО ✅ ВЫПОЛНЕНО
**Проблема**: Не все критические ошибки логируются в админ панель.

**Требование**: Все важные критические ошибки должны быть в блоке "логи" во вкладке админ панели.

**Что нужно логировать**:
- ✅ Ошибки API (все 500 ошибки) - через централизованный exception handler
- ✅ Ошибки записи в БД (sqlite3.IntegrityError, sqlite3.OperationalError, aiosqlite.*) - в `api_server.py` и `main.py`
- ✅ Ошибки подключения к биржам (WebSocket ошибки) - через `on_error` в `main.py`
- ✅ Ошибки отправки в Telegram (aiohttp ошибки, таймауты) - в `telegram_notifier.py` и `main.py`
- ✅ Ошибки парсинга данных (JSON decode errors, ValueError при парсинге) - в `spike_detector.py` и `main.py`
- ✅ Ошибки детекции стрел (исключения в spike_detector) - в `spike_detector.py` и `main.py`

**Исправление**:
- ✅ Проверены и улучшены критические операции в `api_server.py`
- ✅ Все ошибки используют `db.add_error()` с правильными параметрами через `extra={"log_to_db": True}`
- ✅ Добавлено логирование в `telegram_notifier.py`: таймауты, сетевые ошибки, ошибки обработки шаблонов
- ✅ Добавлено логирование в `spike_detector.py`: ошибки получения пользователей, ошибки парсинга JSON
- ✅ Добавлено логирование в `main.py`: ошибки детекции стрел, ошибки сохранения в БД, ошибки отправки в Telegram

**Файлы**: `main.py` ✅, `BD/database.py` ✅, `api_server.py` ✅, `core/spike_detector.py` ✅, `core/telegram_notifier.py` ✅

## Приоритеты

**Критично (сделать немедленно)**:
1. ✅ Добавление rate limiting для защиты от атак - **ВЫПОЛНЕНО**
2. ✅ Централизованная обработка ошибок с логированием в админ панель - **ВЫПОЛНЕНО**
3. ✅ Логирование всех критических ошибок в админ панель - **ВЫПОЛНЕНО** (все критические ошибки логируются)

**Высокий приоритет**:
4. ✅ SQLite конкурентность - переход на aiosqlite - **ВЫПОЛНЕНО** (все 29 методов переделано на async, все вызовы обновлены)
5. ✅ Исправление утечек памяти в _series_tracker - **ВЫПОЛНЕНО** (TTL, ограничение размера, периодическая очистка, очистка при удалении)
6. ✅ Широкие блоки try-except (улучшение обработки ошибок) - **ВЫПОЛНЕНО** (все критичные места в api_server.py, main.py и BD/database.py)

**Средний приоритет**:
7. ✅ Рефакторинг глобальных переменных в main.py - **ВЫПОЛНЕНО** (инкапсулированы в класс ExchangeManager)
8. ✅ Устранение дублирования кода - **ВЫПОЛНЕНО** (созданы утилиты для обработки ошибок БД и работы с подключениями)

---

## Статус выполнения

### ✅ Полностью выполнено:
- Rate limiting для защиты от атак
- Централизованная обработка ошибок в FastAPI
- Переход на aiosqlite - все методы переделаны на async (29 методов), все вызовы обновлены
- Исправление утечек памяти в _series_tracker (TTL, ограничение размера, периодическая очистка, очистка при удалении)
- Логирование критических ошибок (все критические ошибки логируются в админ панель)
- Широкие блоки try-except заменены на конкретные типы исключений (все файлы)
- Рефакторинг глобальных переменных в main.py (инкапсулированы в класс ExchangeManager)
- Устранение дублирования кода (созданы утилиты для обработки ошибок БД и работы с подключениями)

### ⚠️ Частично выполнено:
- (нет)

### ❌ Не выполнено:
- (все задачи выполнены)

