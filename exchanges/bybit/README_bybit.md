# Bybit Integration

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Bybit V5 –¥–ª—è —Å–±–æ—Ä–∞ 1-—Å–µ–∫—É–Ω–¥–Ω—ã—Ö —Å–≤–µ—á–µ–π —Å Spot –∏ Linear (Futures) —Ä—ã–Ω–∫–æ–≤ —á–µ—Ä–µ–∑ –ø–æ—Ç–æ–∫–∏ —Å–¥–µ–ª–æ–∫.

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

–ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ –æ—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å:
```bash
python main.py
```

–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ `config.py`:
```python
config.exchanges.bybit_spot = True    # Spot —Ä—ã–Ω–æ–∫
config.exchanges.bybit_linear = True  # Futures —Ä—ã–Ω–æ–∫
```

## üîå WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

#### Endpoints
- **Spot**: `wss://stream.bybit.com/v5/public/spot`
- **Linear**: `wss://stream.bybit.com/v5/public/linear`
- **–í–µ—Ä—Å–∏—è API**: V5 (—Å–∞–º–∞—è –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è Bybit WebSocket API)
- **–°–ø–æ—Å–æ–± –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `aiohttp.ClientSession.ws_connect()`
- **–§—É–Ω–∫—Ü–∏—è**: `_ws_consumer_with_batches()` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–∞—Ç—á–∞ —Å–∏–º–≤–æ–ª–æ–≤

#### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤ –∫–æ–¥–µ
- **Heartbeat**: 60 —Å–µ–∫—É–Ω–¥ (–ø–∞—Ä–∞–º–µ—Ç—Ä `heartbeat=60` –≤ `ws_connect()`)
- **–¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è**: 180 —Å–µ–∫—É–Ω–¥ (`timeout=aiohttp.ClientTimeout(total=180)`)
- **–ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏**: 0.1 —Å–µ–∫—É–Ω–¥—ã
- **–ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –±–∞—Ç—á–∞–º–∏ –ø–æ–¥–ø–∏—Å–∫–∏**: 0.01 —Å–µ–∫—É–Ω–¥—ã

### Ping/Pong –º–µ—Ö–∞–Ω–∏–∑–º

Bybit –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **—Ä—É—á–Ω–æ–π heartbeat** —á–µ—Ä–µ–∑ JSON —Å–æ–æ–±—â–µ–Ω–∏—è:
- **–ò–Ω—Ç–µ—Ä–≤–∞–ª**: 20 —Å–µ–∫—É–Ω–¥ (`WS_PING_INTERVAL_SEC = 20`)
- **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**: –û—Ç–¥–µ–ª—å–Ω–∞—è asyncio –∑–∞–¥–∞—á–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç JSON —Å–æ–æ–±—â–µ–Ω–∏–µ `{"op": "ping"}`
- **–û–±—Ä–∞–±–æ—Ç–∫–∞**: –û–∂–∏–¥–∞–µ—Ç—Å—è –æ—Ç–≤–µ—Ç `pong` –∏–ª–∏ keepalive —Å–æ–æ–±—â–µ–Ω–∏–µ

```python
async def ping_task_worker():
    while True:
        await asyncio.sleep(WS_PING_INTERVAL_SEC)  # 20 —Å–µ–∫—É–Ω–¥
        await ws.send_json({"op": "ping"})

ping_task = asyncio.create_task(ping_task_worker())
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**:
- –ó–∞–¥–∞—á–∞ ping –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- –ó–∞–¥–∞—á–∞ –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- Ping –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 20 —Å–µ–∫—É–Ω–¥ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –¥—Ä—É–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

## üìä –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–≤–µ—á–µ–π

### –ú–µ—Ö–∞–Ω–∏–∑–º –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è
Bybit **–Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≥–æ—Ç–æ–≤—ã–µ —Å–≤–µ—á–∏** - –æ–Ω–∏ —Å—Ç—Ä–æ—è—Ç—Å—è –∏–∑ –ø–æ—Ç–æ–∫–æ–≤ —Å–¥–µ–ª–æ–∫ (publicTrade) —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `CandleBuilder`:
1. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–¥–µ–ª–æ–∫ –∏–∑ WebSocket –ø–æ—Ç–æ–∫–∞
2. –ê–≥—Ä–µ–≥–∞—Ü–∏—è —Å–¥–µ–ª–æ–∫ –≤ 1-—Å–µ–∫—É–Ω–¥–Ω—ã–µ —Å–≤–µ—á–∏
3. –í–æ–∑–≤—Ä–∞—Ç –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–π —Å–≤–µ—á–∏ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –Ω–æ–≤—É—é —Å–µ–∫—É–Ω–¥—É

### –§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
```json
{
  "topic": "publicTrade.BTCUSDT",
  "type": "snapshot",
  "ts": 1234567890000,
  "data": [
    {
      "T": 1234567890000,  // timestamp
      "s": "BTCUSDT",      // symbol
      "S": "Buy",          // side
      "v": "0.001",        // volume (qty)
      "p": "50000"         // price
    }
  ],
  "cs": 1234567890
}
```

## ‚öôÔ∏è –õ–∏–º–∏—Ç—ã –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ª–∏–º–∏—Ç—ã

#### –õ–∏–º–∏—Ç—ã –≤ –∫–æ–¥–µ

**Spot —Ä—ã–Ω–æ–∫**:
- **–°–∏–º–≤–æ–ª–æ–≤ –Ω–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ**: **86 –ø–∞—Ä** (`WS_SYMBOLS_PER_CONNECTION_SPOT = 86`)
- **–†–∞–∑–º–µ—Ä –±–∞—Ç—á–∞ –ø–æ–¥–ø–∏—Å–∫–∏**: **10 —Å–∏–º–≤–æ–ª–æ–≤** (`BATCH_SIZE_SPOT = 10`)
- **–õ–∏–º–∏—Ç Bybit**: –¥–æ **10 topics** –Ω–∞ –æ–¥–Ω—É –ø–æ–¥–ø–∏—Å–∫—É

**Futures (Linear) —Ä—ã–Ω–æ–∫**:
- **–°–∏–º–≤–æ–ª–æ–≤ –Ω–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ**: **100 –ø–∞—Ä** (`WS_SYMBOLS_PER_CONNECTION_LINEAR = 100`)
- **–ë–∞—Ç—á–µ–π –ø–æ–¥–ø–∏—Å–∫–∏**: –≤—Å–µ —Å–∏–º–≤–æ–ª—ã –≤ –æ–¥–Ω–æ–º –±–∞—Ç—á–µ (–¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤)

**–û–±—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- **Ping –∏–Ω—Ç–µ—Ä–≤–∞–ª**: **20 —Å–µ–∫—É–Ω–¥** (`WS_PING_INTERVAL_SEC = 20`)
- **Heartbeat –≤ ws_connect**: **60 —Å–µ–∫—É–Ω–¥** (–ø–∞—Ä–∞–º–µ—Ç—Ä –±–∏–±–ª–∏–æ—Ç–µ–∫–∏)
- **–¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è**: **180 —Å–µ–∫—É–Ω–¥**

#### –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –ª–∏–º–∏—Ç—ã Bybit V5
- **–õ–∏–º–∏—Ç topics –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É**: **10 topics** (–∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è Spot)
- **–†–∞–∑–¥–µ–ª—å–Ω—ã–µ endpoints**: Spot –∏ Linear –∏–º–µ—é—Ç —Ä–∞–∑–Ω—ã–µ WebSocket URLs
- **–†–∞–∑–Ω—ã–µ –ª–∏–º–∏—Ç—ã**: –î–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Ä—ã–Ω–∫–æ–≤ –º–æ–≥—É—Ç –±—ã—Ç—å —Ä–∞–∑–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ª–∏–º–∏—Ç–∞–º

‚ö†Ô∏è **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ —Å–æ–±–ª—é–¥–∞—Ç—å**:
- **–ù–µ –ø—Ä–µ–≤—ã—à–∞–π—Ç–µ 10 topics –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è Spot** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ –Ω–∞ –±–∞—Ç—á–∏
- **Linear –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤ –≤ –æ–¥–Ω–æ–º –±–∞—Ç—á–µ** - –æ–±—ã—á–Ω–æ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞–∑–±–∏–µ–Ω–∏–µ
- **–°–æ–±–ª—é–¥–∞–π—Ç–µ –∑–∞–¥–µ—Ä–∂–∫—É 0.01 —Å–µ–∫—É–Ω–¥—ã –º–µ–∂–¥—É –±–∞—Ç—á–∞–º–∏** - –¥–ª—è —Å–æ–±–ª—é–¥–µ–Ω–∏—è —Ä–µ–π—Ç-–ª–∏–º–∏—Ç–æ–≤
- **–ù–µ –∏–∑–º–µ–Ω—è–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –±–µ–∑ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è** - –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –æ—à–∏–±–∫–∞–º –ø–æ–¥–ø–∏—Å–∫–∏

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞—Ç—á–µ–π

**Spot - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ**:
```python
# –°–æ–∑–¥–∞—ë–º –±–∞—Ç—á–∏ –≤–Ω—É—Ç—Ä–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (10 —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ –±–∞—Ç—á –¥–ª—è SPOT)
batches_in_conn = []
for batch_idx in range(0, len(connection_symbols), BATCH_SIZE_SPOT):
    batch_symbols = connection_symbols[batch_idx:batch_idx+BATCH_SIZE_SPOT]
    batch_id = f"{connection_id}-B{batch_idx//BATCH_SIZE_SPOT + 1}"
    batches_in_conn.append((batch_id, batch_symbols))
```

**Linear - –æ–¥–∏–Ω –±–∞—Ç—á**:
```python
# –°–æ–∑–¥–∞—ë–º –æ–¥–∏–Ω –±–∞—Ç—á —Å–æ –≤—Å–µ–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏ –¥–ª—è LINEAR
batches_in_conn = [(connection_id, connection_symbols)]
```

**–ü—Ä–∏–º–µ—Ä**:
- 250 —Å–∏–º–≤–æ–ª–æ–≤ Spot ‚Üí 3 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (86 + 86 + 78), –∫–∞–∂–¥–æ–µ —Å 9-10 –±–∞—Ç—á–∞–º–∏
- 180 —Å–∏–º–≤–æ–ª–æ–≤ Linear ‚Üí 2 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (100 + 80), –∫–∞–∂–¥–æ–µ —Å 1-2 –±–∞—Ç—á–∞–º–∏

## üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç–∞

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Ä–∞–∑—Ä—ã–≤–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:
- **–ó–∞–¥–µ—Ä–∂–∫–∞**: —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π backoff –æ—Ç 2 –¥–æ 60 —Å–µ–∫—É–Ω–¥
- **–§–æ—Ä–º—É–ª–∞**: `min(2 ^ min(reconnect_attempt - 1, 5), 60)`
- **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞**: 60 —Å–µ–∫—É–Ω–¥ (`max_reconnect_delay = 60`)
- **–°—á—ë—Ç—á–∏–∫**: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç–æ–≤ –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ (`_stats[market]["reconnects"]`)
- **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ**: –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç–∞ —á–µ—Ä–µ–∑ callback `on_error()`

**–ê–ª–≥–æ—Ä–∏—Ç–º —Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç–∞**:
```python
reconnect_attempt += 1
if reconnect_attempt > 1:
    delay = min(2 ** min(reconnect_attempt - 1, 5), max_reconnect_delay)
    _stats[market]["reconnects"] += 1
    await on_error({
        "exchange": "bybit",
        "market": market,
        "connection_id": connection_id,
        "type": "reconnect",
    })
    await asyncio.sleep(delay)
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- **–ü–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞**: 2 —Å–µ–∫—É–Ω–¥—ã
- **–í—Ç–æ—Ä–∞—è –ø–æ–ø—ã—Ç–∫–∞**: 4 —Å–µ–∫—É–Ω–¥—ã
- **–¢—Ä–µ—Ç—å—è –ø–æ–ø—ã—Ç–∫–∞**: 8 —Å–µ–∫—É–Ω–¥
- **–ß–µ—Ç–≤—ë—Ä—Ç–∞—è –ø–æ–ø—ã—Ç–∫–∞**: 16 —Å–µ–∫—É–Ω–¥
- **–ü—è—Ç–∞—è –ø–æ–ø—ã—Ç–∫–∞**: 32 —Å–µ–∫—É–Ω–¥—ã
- **–î–∞–ª–µ–µ**: 60 —Å–µ–∫—É–Ω–¥ (–º–∞–∫—Å–∏–º—É–º)

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**:
- –í—Å–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `logger.error()`
- –ü—Ä–∏ —Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è callback `on_error()` —Å —Ç–∏–ø–æ–º "reconnect"
- Ping –∑–∞–¥–∞—á–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- –¶–∏–∫–ª –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ –¥–æ —è–≤–Ω–æ–π –æ—Ç–º–µ–Ω—ã –∑–∞–¥–∞—á–∏

## üì° –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª—ã

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏

#### –§–æ—Ä–º–∞—Ç –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è Spot
```json
{
  "op": "subscribe",
  "args": [
    "publicTrade.BTCUSDT",
    "publicTrade.ETHUSDT",
    "publicTrade.LTCUSDT"
    // –º–∞–∫—Å–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ –æ–¥–∏–Ω –±–∞—Ç—á
  ]
}
```

#### –§–æ—Ä–º–∞—Ç –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è Linear
```json
{
  "op": "subscribe",
  "args": [
    "publicTrade.BTCUSDT",
    "publicTrade.ETHUSDT"
    // –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ —Å–∏–º–≤–æ–ª–æ–≤, —á–µ–º –¥–ª—è spot (–¥–æ 100 –Ω–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ)
  ]
}
```

#### –ú–µ—Ö–∞–Ω–∏–∑–º –ø–æ–¥–ø–∏—Å–∫–∏

**–ü–æ—à–∞–≥–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å**:
1. **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ**: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
2. **–†–∞–∑–±–∏–µ–Ω–∏–µ –Ω–∞ –±–∞—Ç—á–∏**: 
   - **Spot**: –°–∏–º–≤–æ–ª—ã —Ä–∞–∑–±–∏–≤–∞—é—Ç—Å—è –Ω–∞ –±–∞—Ç—á–∏ –ø–æ 10 —à—Ç—É–∫ (`BATCH_SIZE_SPOT = 10`)
   - **Linear**: –í—Å–µ —Å–∏–º–≤–æ–ª—ã –≤ –æ–¥–Ω–æ–º –±–∞—Ç—á–µ (–¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤)
3. **–û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏**: –î–ª—è –∫–∞–∂–¥–æ–≥–æ –±–∞—Ç—á–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è JSON —Å–æ–æ–±—â–µ–Ω–∏–µ
4. **–ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –±–∞—Ç—á–∞–º–∏**: 0.01 —Å–µ–∫—É–Ω–¥—ã –º–µ–∂–¥—É –±–∞—Ç—á–∞–º–∏ –ø–æ–¥–ø–∏—Å–∫–∏

**–ö–æ–¥ –ø–æ–¥–ø–∏—Å–∫–∏**:
```python
# –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∫–∞–∂–¥—ã–π –±–∞—Ç—á –æ—Ç–¥–µ–ª—å–Ω–æ (–ª–∏–º–∏—Ç Bybit: max 10 topics per subscribe)
for batch_id, batch_symbols in batches:
    batch_args = [f"publicTrade.{sym}" for sym in batch_symbols]
    subscribe_msg = {"op": "subscribe", "args": batch_args}
    await ws.send_json(subscribe_msg)
    await asyncio.sleep(0.01)  # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–¥–ø–∏—Å–∫–∞–º–∏
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**:
- Spot —Ç—Ä–µ–±—É–µ—Ç —Ä–∞–∑–±–∏–µ–Ω–∏—è –Ω–∞ –±–∞—Ç—á–∏ –∏–∑-–∑–∞ –ª–∏–º–∏—Ç–∞ 10 topics –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É
- Linear –æ–±—ã—á–Ω–æ –ø–æ–º–µ—â–∞–µ—Ç—Å—è –≤ –æ–¥–∏–Ω –±–∞—Ç—á
- –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –±–∞—Ç—á–∞–º–∏ –¥–ª—è —Å–æ–±–ª—é–¥–µ–Ω–∏—è —Ä–µ–π—Ç-–ª–∏–º–∏—Ç–æ–≤

### –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏

**–û—Ç–≤–µ—Ç –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É**:
```json
{
  "success": true,
  "ret_msg": "subscribe",
  "conn_id": "xxx",
  "req_id": "xxx",
  "op": "subscribe"
}
```

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞**:
```python
if "op" in data:
    op = data["op"]
    if op == "subscribe":
        success = data.get("success")
        if not success:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏: {data}")
```

**–û—à–∏–±–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏**: –õ–æ–≥–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `logger.error()` —Å –ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –æ—Ç–≤–µ—Ç–∞

### –û—Ç–ø–∏—Å–∫–∞ –æ—Ç –∫–∞–Ω–∞–ª–æ–≤

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è**: –Ø–≤–Ω–∞—è –æ—Ç–ø–∏—Å–∫–∞ **–Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞**

**–ü—Ä–∏—á–∏–Ω–∞**:
- –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –≤—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–º–µ–Ω—è—é—Ç—Å—è
- –ü—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è `task.cancel()` –¥–ª—è –≤—Å–µ—Ö –∑–∞–¥–∞—á
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è —è–≤–Ω–∞—è –æ—Ç–ø–∏—Å–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

**–ï—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤ –±—É–¥—É—â–µ–º**:
```python
unsubscribe_msg = {
    "op": "unsubscribe",
    "args": ["publicTrade.BTCUSDT", "publicTrade.ETHUSDT"]
}
await ws.send_json(unsubscribe_msg)
```

## üîç –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤

### REST API Endpoint
- **URL**: `https://api.bybit.com/v5/market/instruments-info`
- **–ú–µ—Ç–æ–¥**: GET
- **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
  - `category`: `spot` –∏–ª–∏ `linear`
  - `limit`: 1000 (–º–∞–∫—Å–∏–º—É–º –Ω–∞ –∑–∞–ø—Ä–æ—Å)

### –§–∏–ª—å—Ç—Ä—ã
- **Status**: –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `Trading` –∏–ª–∏ —Å—Ç–∞—Ç—É—Å `1`
- **Quote**: —Ç–æ–ª—å–∫–æ —Å–∏–º–≤–æ–ª—ã —Å –∫–æ—Ç–∏—Ä—É–µ–º—ã–º –∞–∫—Ç–∏–≤–æ–º `USDT`
- **–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç**: –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ—å—é—á–µ—Ä—Å—ã –¥–ª—è Linear, –≤—Å–µ –ø–∞—Ä—ã –¥–ª—è Spot

## üõ†Ô∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### Trade —Å–æ–æ–±—â–µ–Ω–∏–µ
```python
{
  "T": int,       # Timestamp —Å–¥–µ–ª–∫–∏ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
  "s": str,       # Symbol (–Ω–∞–ø—Ä–∏–º–µ—Ä, "BTCUSDT")
  "S": str,       # Side ("Buy" –∏–ª–∏ "Sell")
  "v": str,       # Volume (—Ä–∞–∑–º–µ—Ä —Å–¥–µ–ª–∫–∏ –≤ –±–∞–∑–æ–≤–æ–π –≤–∞–ª—é—Ç–µ)
  "p": str        # Price (—Ü–µ–Ω–∞ —Å–¥–µ–ª–∫–∏)
}
```

### –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–≤–µ—á–∏
```python
candle = Candle(
    ts_ms=trade_ts // 1000 * 1000,  # –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ –Ω–∞—á–∞–ª–∞ —Å–µ–∫—É–Ω–¥—ã
    open=first_trade_price,
    high=max_price,
    low=min_price,
    close=last_trade_price,
    volume=sum_of_quantities,  # –û–±—ä—ë–º –≤ –±–∞–∑–æ–≤–æ–π –≤–∞–ª—é—Ç–µ
    market="spot" or "linear",
    exchange="bybit",
    symbol="BTCUSDT"
)
```

## üìù –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### Batches –≤–Ω—É—Ç—Ä–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
Bybit —Ç—Ä–µ–±—É–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å–∏–º–≤–æ–ª–æ–≤:
- **Spot**: —Å–∏–º–≤–æ–ª—ã —Ä–∞–∑–±–∏–≤–∞—é—Ç—Å—è –Ω–∞ –±–∞—Ç—á–∏ –ø–æ 10 –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- **Linear**: –≤—Å–µ —Å–∏–º–≤–æ–ª—ã –æ–±—ã—á–Ω–æ –ø–æ–¥–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
- **–ó–∞–¥–µ—Ä–∂–∫–∞**: 0.01 —Å–µ–∫—É–Ω–¥—ã –º–µ–∂–¥—É –±–∞—Ç—á–∞–º–∏ –ø–æ–¥–ø–∏—Å–∫–∏

### –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
```python
# –†–∞—Å–ø–∞—Ä—Å–∏–≤–∞–Ω–∏–µ topic –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è symbol
if "topic" in data:
    topic = data["topic"]  # "publicTrade.BTCUSDT"
    symbol = topic.replace("publicTrade.", "")
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∂–¥–æ–π —Å–¥–µ–ª–∫–∏
    for trade in data.get("data", []):
        price = float(trade["p"])
        qty = float(trade["v"])
        ts_ms = int(trade["T"])
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è Bybit V5 API
- –ñ—ë—Å—Ç–∫–∏–π –ª–∏–º–∏—Ç 10 topics –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É (–∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è Spot)
- –î–≤–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö endpoint –¥–ª—è Spot –∏ Linear
- –†–∞–∑–Ω—ã–µ –ª–∏–º–∏—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Ä—ã–Ω–∫–æ–≤

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –±–∞—Ç—á–∏ –¥–ª—è Spot
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø–æ–¥–ø–∏—Å–∫–∏ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- Graceful degradation –ø—Ä–∏ —Ä–∞–∑—Ä—ã–≤–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- Cleanup —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- –û—à–∏–±–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –æ—Ç–≤–µ—Ç–∞
- –û—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–¥–µ–ª–æ–∫ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è, –Ω–æ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç —Ä–∞–±–æ—Ç—É
- –†–∞–∑—Ä—ã–≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç —Å backoff

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
```python
from exchanges.bybit import ws_handler

stats = ws_handler.get_statistics()
print(f"Spot: {stats['spot']['active_connections']} connections, "
      f"{stats['spot']['active_symbols']} symbols, "
      f"{stats['spot']['reconnects']} reconnects")
```

### –õ–æ–≥–∏
–í—Å–µ –≤–∞–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è/–æ—Ç–∫–ª—é—á–µ–Ω–∏—è
- –û—à–∏–±–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –∏ —Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç—ã
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã
- –û—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞

## üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [Bybit WebSocket V5 API Docs](https://bybit-exchange.github.io/docs/v5/websocket/public/trade)
- [Bybit REST API V5](https://bybit-exchange.github.io/docs/v5/intro)
- [Bybit Public Trade Topic](https://bybit-exchange.github.io/docs/v5/websocket/public/trade)

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–∞–∑–±–∏–µ–Ω–∏—è –Ω–∞ –±–∞—Ç—á–∏ –¥–ª—è Spot
2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ —Å–∏–º–≤–æ–ª—ã –ø–æ–¥–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ —Ä–∞–∑—Ä—ã–≤–∞–º (Ctrl+C –∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ)
4. –ù–∞–±–ª—é–¥–∞—Ç—å –∑–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç–æ–≤ –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è —Å–≤–µ—á–µ–π –∏–∑ —Å–¥–µ–ª–æ–∫

## üéØ –û—Ç–ª–∏—á–∏—è –æ—Ç –¥—Ä—É–≥–∏—Ö –±–∏—Ä–∂

1. **–î–≤–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö endpoint**: Spot –∏ Linear –∏–º–µ—é—Ç —Ä–∞–∑–Ω—ã–µ WebSocket URLs
2. **–ñ—ë—Å—Ç–∫–∏–π –ª–∏–º–∏—Ç –±–∞—Ç—á–µ–π**: –º–∞–∫—Å–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É
3. **–û—Ç–¥–µ–ª—å–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á**: _spot_tasks –∏ _linear_tasks –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
4. **Topic-based —Ñ–æ—Ä–º–∞—Ç**: —Ñ–æ—Ä–º–∞—Ç `publicTrade.SYMBOL` –≤–º–µ—Å—Ç–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

