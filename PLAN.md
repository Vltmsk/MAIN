# План разработки

## 1. Переделать вкладку стратегии

**Статус:** ✅ Завершено (7/7 этапов выполнено)

**Прогресс:**
- ✅ Этап 1: Базовая структура трехколоночного layout
- ✅ Этап 2: Левая панель (дерево стратегий с фильтром)
- ✅ Этап 3: Центральная панель (детали стратегии)
- ✅ Этап 4: Правая панель (действия) - вынесена в отдельный компонент StrategyActionsPanel.tsx
- ✅ Этап 5: Интеграция компонентов - все три панели интегрированы
- ✅ Этап 6: Валидация и обработка ошибок - базовая валидация реализована, код очищен от дублирования
- ✅ Этап 7: Тестирование и доработка UX - завершено

### Общая концепция
Переделать вкладку стратегий в трехколоночный интерфейс, похожий на мунбот стратегии, но с сохранением стиля проекта (темная тема, zinc цвета, emerald акценты).

### Структура интерфейса

#### Левая панель (Список стратегий) - ~25% ширины ✅
- ✅ **Заголовок**: "Стратегии" с иконкой

- ✅ **Дерево стратегий**:
  - ✅ Каждая стратегия в списке:
    - ✅ Чекбокс для выбора (для массовых операций)
    - ✅ Номер стратегии (#N)
    - ✅ Название стратегии (без названия невозможно сохранить стратегию)
    - ✅ Визуальная индикация статуса:
      - ✅ Включена/выключена (через enabled)
      - ✅ Активна/неактивна (визуально через цвет/прозрачность)
    - ✅ Иконка лампочки для стратегий, которые запущены
  - ✅ Выделение выбранной стратегии (синий фон, как в примере)
  - ✅ Скролл для длинных списков
- ✅ **Дополнительное поле внизу** (опционально):
  - ✅ Текстовое поле "Дополнительный комментарий к стратегии, параметр не обязателен"
  - ✅ Применяется к выбранной стратегии (функционал сохранения комментария реализован)

#### Центральная панель (Детали стратегии) - ~50% ширины ✅
- ✅ **Заголовок**:
  - ✅ Название стратегии (например, "DropB (DropsDetection)")
  
- ✅ **Основная секция "Main"**:
  - ✅ Таблица параметров в формате "Параметр | Значение":
    - ✅ **Название стратегии (name)**: текстовое поле (обязательно для сохранения)
      - ✅ Tooltip: "Уникальное название стратегии. Обязательное поле для сохранения."
    - ✅ **Описание (description)**: только для чтения (генерируется автоматически на основе условий)
      - ✅ Tooltip: "Автоматически генерируемое описание стратегии на основе заданных условий. Обновляется при изменении условий."
    - ✅ **Chat ID (chatId)**: текстовое поле (опционально, для отдельного Telegram чата)
      - ✅ Tooltip: "Опциональный Chat ID для отправки уведомлений в отдельный Telegram чат. Если не указан, используется глобальный Chat ID из настроек."
  - ✅ **Примечание**: Все параметры в таблице имеют tooltips (всплывающие подсказки) при наведении мышки, которые появляются сбоку в отдельном окошке с подробным описанием параметра
  - ✅ **Секция "Использовать глобальные фильтры" (useGlobalFilters)**:
    - ✅ Чекбокс с описанием
    - ✅ Если включено: стратегия использует фильтры из глобальных настроек пары (pairSettings)
    - ✅ Если выключено: необходимо указать базовые фильтры в условиях стратегии
  - ✅ **Секция "Базовые фильтры"** (показывается только если useGlobalFilters = false):
    - ✅ Обязательные поля для работы стратегии:
      - ✅ **Дельта (delta)**: числовое поле (минимальная дельта стрелы в %)
        - ✅ Tooltip: "Минимальная дельта стрелы в процентах. Используется для фильтрации стрел по размеру изменения цены. Значение от 0.01% до 100%."
      - ✅ **Объём (volume)**: числовое поле (минимальный объём стрелы в USDT)
        - ✅ Tooltip: "Минимальный объём стрелы в USDT. Используется для фильтрации стрел по объёму торгов. Значение от 1 USDT."
      - ✅ **Тень (wick_pct)**: числовое поле (от в %)
        - ✅ Tooltip: "Минимальная тень свечи в процентах. Определяет минимальный процент тени (верхней или нижней части свечи) для фильтрации стрел."
    - ✅ Валидация: если стратегия включена и useGlobalFilters = false, все три поля обязательны
    - ✅ Визуальная индикация ошибок валидации
    - ✅ **Примечание**: Все поля имеют tooltips при наведении мышки
  - ✅ **Секция "Условия" (conditions)**:
    - ✅ Заголовок: "Условия (все должны выполняться)"
    - ✅ Список условий стратегии:
      - ✅ Каждое условие в отдельной строке
      - ✅ Выпадающий список типа условия (с tooltips при наведении):
        - ✅ **Объём (volume)**: значение в USDT (≥)
        - ✅ **Дельта (delta)**: значение в % (≥)
        - ✅ **Тень свечи (wick_pct)**: значение от в %
        - ✅ **Серия стрел (series)**: количество стрел (≥) и окно времени в секундах
        - ✅ **Символ (symbol)**: конкретная монета (например, BTC, ETH)
        - ✅ **Биржа и тип рынка (exchange_market)**: выпадающий список (Binance Spot, Bybit Futures и т.д.)
        - ✅ **Направление стрелы (direction)**: Вверх ⬆️ или Вниз ⬇️
      - ✅ Поля ввода в зависимости от типа условия
      - ✅ Кнопка удаления условия (×)
    - ✅ Кнопка "Добавить условие" для добавления нового условия
    - ✅ Описание автоматически обновляется при изменении условий
  - ✅ **Секция "Шаблон сообщения" (template)**:
    - ✅ Блок с доступными вставками (placeholder'ы):
      - ✅ [[Дельта стрелы]] - процент дельты
      - ✅ [[Направление]] - эмодзи стрелки вверх/вниз
      - ✅ [[Биржа и тип рынка]] - название биржи и тип рынка
      - ✅ [[Торговая пара]] - символ пары (например, BTC-USDT)
      - ✅ [[Объём стрелы]] - объём в USDT
      - ✅ [[Тень свечи]] - процент тени свечи
      - ✅ [[Время детекта]] - дата и время детекта
      - ✅ [[Временная метка]] - Unix timestamp
    - ✅ Редактор шаблона (contentEditable) с поддержкой форматирования
    - ✅ Превью сообщения в Telegram с примерами значений

#### Правая панель (Действия) - ~25% ширины ✅
Вертикальный список кнопок с иконками:
- ✅ **"Стоп все"** (красная иконка руки/стоп):
  - ✅ Останавливает все активные стратегии (enabled = false для всех)
  - ✅ Подтверждение перед выполнением
- ✅ **"Старт отмеченные"** (зеленая иконка play):
  - ✅ Запускает выбранные через чекбоксы стратегии (enabled = true)
  - ✅ Показывает количество выбранных
- ✅ **"Добавить новую"** (желтая иконка звезды/плюса):
  - ✅ Создает новую стратегию с дефолтными настройками
  - ✅ Автоматически выбирает новую стратегию в списке
- ✅ **"Сохранить"** (иконка дискеты):
  - ✅ Сохраняет все изменения активной выбранной стратегии
  - ✅ Показывает индикатор загрузки при сохранении
  - ✅ Уведомление об успешном сохранении/ошибке (интегрировано с общей системой уведомлений)
  - ✅ Валидация перед сохранением (проверка названия стратегии)
- ✅ **"Закрыть"** (иконка крестика):
  - ✅ Закрывает выбранную стратегию, центральная панель (Main) остаётся пустой
  - ✅ Предупреждение при наличии несохраненных изменений

### Технические детали

#### Компоненты для создания:
1. ✅ **StrategiesTreeView.tsx** - левая панель с деревом стратегий
   - ✅ Компонент фильтра
   - ✅ Компонент узла дерева (TreeNode) - реализован внутри StrategiesTreeView
   - ✅ Компонент элемента стратегии (StrategyItem) - реализован внутри StrategiesTreeView
   
2. ✅ **StrategyDetailsPanel.tsx** - центральная панель с деталями
   - ✅ Компонент таблицы параметров (ParameterTable) - реализован внутри StrategyDetailsPanel
   - ✅ Компонент коллапсируемой секции (CollapsibleSection) - реализован через expandedSections
   - ✅ Компонент редактора условий (ConditionsEditor) - реализован внутри StrategyDetailsPanel
   - ✅ Компонент редактора шаблона (TemplateEditor) - реализован внутри StrategyDetailsPanel
   
3. ✅ **StrategyActionsPanel.tsx** - правая панель с действиями
   - ✅ Компоненты кнопок действий - вынесены в отдельный компонент StrategyActionsPanel.tsx

4. ✅ **StrategiesSettings.tsx** (обновленный) - главный компонент
   - ✅ Управление состоянием выбранной стратегии
   - ✅ Управление состоянием выбранных стратегий (для массовых операций)
   - ✅ Интеграция всех панелей - все три панели интегрированы

#### Состояния для управления:
- ✅ `selectedStrategyIndex: number | null` - индекс выбранной стратегии
- ✅ `selectedStrategies: Set<number>` - множество индексов выбранных стратегий (через чекбоксы)
- ✅ `expandedSections: Set<string>` - множество развернутых секций в деталях (реализовано в StrategyDetailsPanel)
- ✅ `filterText: string` - текст фильтра
- ✅ `hasUnsavedChanges: boolean` - флаг несохраненных изменений

#### Функциональность:
- ✅ **Выбор стратегии**: клик по элементу в дереве → загрузка деталей в центральную панель (базовая реализация)
- ✅ **Массовый выбор**: чекбоксы в дереве → выбор нескольких стратегий
- ✅ **Фильтрация**: ввод текста → фильтрация дерева в реальном времени
- ✅ **Сохранение**: кнопка "Сохранить" → валидация → отправка на сервер → обновление UI (валидация базовых фильтров реализована, общая валидация интегрирована)
- ✅ **Сохранение комментария**: комментарий к стратегии сохраняется при изменении
- ✅ **Tooltips (всплывающие подсказки)**:
  - ✅ Все параметры в таблице "Параметр | Значение" имеют tooltips при наведении мышки
  - ✅ Tooltips появляются сбоку в отдельном окошке с подробным описанием параметра
  - ✅ Использован кастомный компонент Tooltip с нативной реализацией
  - ✅ Tooltips стилизованы в соответствии с темой проекта (темный фон, emerald акценты)

#### Стилизация (соответствие проекту): ✅
- ✅ Фон: `bg-zinc-900`, `bg-zinc-800` для панелей
- ✅ Границы: `border-zinc-700`, `border-zinc-600`
- ✅ Акценты: `emerald-500`, `emerald-600` для активных элементов
- ✅ Текст: `text-white`, `text-zinc-300`, `text-zinc-400`
- ✅ Выделение: `bg-blue-600/20` или `bg-emerald-500/10` для выбранной стратегии
- ✅ Кнопки: градиенты для основных действий (`from-emerald-500 to-emerald-600`)
- ✅ Hover эффекты: `hover:bg-zinc-700`, `hover:border-emerald-500/60`

#### Адаптивность: ✅
- ✅ На мобильных устройствах: вертикальный layout (панели друг под другом) - реализовано через `flex-col`
- ✅ На планшетах: левая и центральная панели рядом, правая панель внизу - улучшена адаптивность через `lg:flex-row` и `xl:hidden`
- ✅ На десктопе: трехколоночный layout - реализовано через `xl:block` для правой панели

### Этапы реализации:
1. ✅ Создать базовую структуру трехколоночного layout
2. ✅ Реализовать левую панель (дерево стратегий с фильтром)
3. ✅ Реализовать центральную панель (детали стратегии)
4. ✅ Реализовать правую панель (действия) - вынесена в отдельный компонент StrategyActionsPanel.tsx
5. ✅ Интегрировать все компоненты - все три панели интегрированы
6. ✅ Добавить валидацию и обработку ошибок - базовая валидация реализована (валидация базовых фильтров работает)
7. ✅ Тестирование и доработка UX - завершено:
   - ✅ Добавлены уведомления об успешном сохранении/ошибке
   - ✅ Улучшена адаптивность на планшетах (левая и центральная панели, правая панель внизу)
   - ✅ Добавлена валидация названия стратегии перед сохранением
   - ✅ Добавлена визуальная индикация ошибок для поля названия
   - ✅ Улучшены подсказки (tooltips) для кнопок действий

## 2. Улучшение настройки фильтров пользователей
- Сделать настройку фильтров пользователей в админ панели удобнее
- Улучшить UX для работы с фильтрами

## 3. Исправление графиков
- Проблема: графики присылаются кривыми
- Варианты решения:
  - Доделать текущую реализацию графиков
  - Хранить трейды в кэше и строить график по ним (так как через REST API криво приходит иногда, непонятно почему)

## 4. Проверка работы стратегий
- Проверить, что стратегии работают после большого обновления кода
- Убедиться, что логика не поменялась в коде
- Проверить, что стратегии корректно детектят сигналы

## 5. Проверка логирования ошибок
- Проверить отображение "логов ошибок" в админ панели
- Есть ощущение, что данные показываются неправильно
- Исправить отображение логов ошибок

